{% extends "base.html" %}

{% block content %}
<h1>Fund Wallet</h1>
<div class="hero">
  Raiden needs funds for its operation
</div>

<div class="info-panel">
  <p>
    For example, ETH is required to create payment channels while RDN is the currency used
    by the
    <a href="https://medium.com/raiden-network/raiden-service-bundle-explained-f9bd3f6f358d" target="_blank">
      Raiden Service Bundle</a>.
    Please fund the Raiden account (with address below) with at least <strong>{{ minimum_eth_required.formatted }}</strong> and approx. <strong>{{ minimum_rdn_required.formatted }}</strong>.</p>
  <p><em>If you don't have RDN tokens, send some extra ETH and we can help you use it to buy RDN at a later step.</em></p>
  <div class="transfer-data-display">
    <div>
      <p>Current balance</p>
      <ul class="account-info">
        <li>
          <span class="account-eth-balance highlighted">N/A ETH</span>
        </li>
        <li>
          <span class="account-rdn-balance highlighted">N/A RDN</span>
        </li>
      </ul>

      <ul class="action-list">
        <li>
          <button disabled class="hide-when-disabled" id="btn-web3-eth" onClick="sendEthViaWeb3();">
            Send ETH
          </button>
        </li>
        <li>
          <button disabled class="hide-when-disabled" id="btn-web3-rdn" onClick="sendRdnViaWeb3();">
            Send RDN
          </button>
        </li>
      </ul>
    </div>
    <div>
      <p>Wallet QR Code</p>
      <div id="address-qr-code" class="qr-code"></div>
    </div>
  </div>
  <p>Wallet Address</p>
  <div class="action-copy-paste">
    <span class="account-address highlighted">{{ configuration_file.account.address }}</span>
  </div>
</div>
<div class="action">
  <button disabled
          id="btn-swap"
          class="link-button"
          data-link-url="{{ reverse_url('swap-options', configuration_file.file_name) }}">
    Convert ETH into RDN
  </button>
  <button disabled
          id="btn-launch" class="link-button"
          data-link-url="{{ reverse_url('launch', configuration_file.file_name) }}">
    Launch
  </button>
</div>
{% end %}


{% block page_header_scripts %}
<script type="text/javascript">
 const WEB3_ETH_AMOUNT_ATTRIBUTE = "data-requested-eth-amount";
 const WEB3_RDN_AMOUNT_ATTRIBUTE = "data-requested-rdn-amount";
 const KYBER_EXCHANGE_RATE_ATTRIBUTE = "data-kyber-exchange-rate";
 const TARGET_ADDRESS = "{{ configuration_file.account.address }}";

 function checkWeb3Network() {
   let required_chain_id = "{{ configuration_file.network.chain_id }}";
   web3.version.getNetwork(function(error, chain_id){
     if (error) {
       console.error(error);
     }

     if (chain_id != required_chain_id) {
       let current_chain_name = CHAIN_ID_MAPPING[chain_id];
       let required_chain_name = CHAIN_ID_MAPPING[required_chain_id];
       alert(`Web3 Browser connected to ${current_chain_name}, please change to ${required_chain_name}.`);
     }
   })
 }

 function makeWeb3Transaction(w3, transaction_data) {
   w3.eth.sendTransaction(transaction_data, function(error, result) {
     if (result) {
       // result is the transaction hash
       trackTransaction(result, "{{ configuration_file.file_name }}");
     }

     if (error) {
       console.error(error);
     }
   });
 }

 function sendEthViaWeb3(wei_to_send) {
   checkWeb3Network();
   let web3 = window.web3;
   let sender_address = (window.ethereum && window.ethereum.selectedAddress) || web3.eth.defaultAccount;

   let transaction_data = {
     from: sender_address,
     to: TARGET_ADDRESS,
     value: wei_to_send || REQUIRED_ETH_AS_WEI
   }

   makeWeb3Transaction(web3, transaction_data);
 };

 function sendRdnViaWeb3(rei_to_send) {
   checkWeb3Network();

   let web3 = window.web3;
   let rdn_address = RDN_TOKEN_ADDRESSES["{{ configuration_file.network.name }}"];
   let rdn_amount = rei_to_send || REQUIRED_RDN_AS_WEI;
   let contract = web3.eth.contract(EIP20_ABI).at(rdn_address);
   let contract_data = contract.transfer.getData(TARGET_ADDRESS, rdn_amount);
   let sender_address = (window.ethereum && window.ethereum.selectedAddress) || web3.eth.defaultAccount;

   let transaction_data = {
     from: sender_address,
     to: rdn_address,
     data: contract_data
   }

   makeWeb3Transaction(web3, transaction_data);
 }

 async function calculateNeededFunds(balance) {
   let kyber_exchange_rate = await getKyberExchangeRate("RDN");

   let eth_balance = balance && balance.ETH.as_wei;
   let rdn_balance = balance && balance.RDN.as_wei;

   let needed_eth = REQUIRED_ETH_AS_WEI;
   let needed_rdn = REQUIRED_RDN_AS_WEI;

   // If we already have some RDN, deduct from total needed
   if (rdn_balance) {
     needed_rdn -= rdn_balance;
   }

   // If we already have some ETH, deduct from total needed
   if (eth_balance) {
     needed_eth -= eth_balance;
   }

   // convert needed RDN into needed ETH for calculation via swap
   if (needed_rdn >= 0 && kyber_exchange_rate){
     needed_eth += (needed_rdn * kyber_exchange_rate);
   }

   needed_eth = Math.max(needed_eth, 0);
   needed_rdn = Math.max(needed_rdn, 0);

   return {
     eth: needed_eth,
     rdn: needed_rdn
   }
 }

 function updateDisplay(balance) {
   let eth_balance_display_element = document.querySelector("span.account-eth-balance");
   let rdn_balance_display_element = document.querySelector("span.account-rdn-balance");

   updateBalanceDisplay(balance, eth_balance_display_element, rdn_balance_display_element);
 }

 async function poll() {
   let balance = await getBalances("{{ reverse_url('api-configuration-detail', configuration_file.file_name) }}");

   let button_launch = document.getElementById("btn-launch");
   let button_swap = document.getElementById("btn-swap");
   let has_web3 = Boolean(window.ethereum || window.web3);

   updateDisplay(balance);

   button_launch.disabled = !(hasEnoughBalanceToLaunchRaiden(balance));
   button_swap.disabled = !(balance.ETH && balance.ETH.as_wei > 0);
 }

 function generateQRCode(display_element) {
   let address = "{{ configuration_file.account.address }}";

   return new QRCode(display_element, {
     text: `ethereum:${address}`,
     colorDark : "#000000",
     colorLight : "#ffffff",
     correctLevel : QRCode.CorrectLevel.H
   });
 }

 function main() {
   poll();
 }

 window.addEventListener("load", async function () {
   let has_web3 = Boolean(window.ethereum || window.web3);
   let button_send_eth = document.getElementById("btn-web3-eth");
   let button_send_rdn = document.getElementById("btn-web3-rdn");

   button_send_eth.disabled = button_send_rdn.disabled = !has_web3;

   if (has_web3) {
     // Modern dapp browsers...
     if (window.ethereum) {
       console.log("Using modern dapp browser");
       window.web3 = new Web3(ethereum);
       try {
         // Request account access if needed
         await ethereum.enable();
       } catch (error) {
         console.log(error);
       }
     }
     // Legacy dapp browsers...
     else if (window.web3) {
       console.log("Using legacy web3");
       window.web3 = new Web3(web3.currentProvider);
     }
     // Non-dapp browsers...
     else {
       console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');
     }
   }
 });


 window.addEventListener("load", function () {
   let address_div_elem = document.querySelector("div.action-copy-paste");
   let account_address_elem = address_div_elem.querySelector("span.account-address");
   let qr_code = generateQRCode(document.getElementById("address-qr-code"));


   address_div_elem.addEventListener("click", function(evt) {
     copyToClipboard(address_div_elem, account_address_elem);
   });

   window.MAIN_VIEW_INTERVAL = 10000;
   window.runMainView();
 });
</script>
{% end %}
