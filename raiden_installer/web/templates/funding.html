{% extends "base.html" %}

{% block content %}
<div id="funding-options">
  <div class="balance-tracker">
    <p class="long tbd">
      To be able to operate this Raiden node, its account needs to have RDN
      tokens in its funds to pay for some of the services provided, such
      as fees for mediated transfers or to have Monitoring Service
      ensuring you receive payments even if your node is offline.
    </p>

    <p class="long tbd">
      You will be able to launch Raiden as soon as this account is funded with at least 1 RDN.
    </p>


    <ul class="account-info">
      <li>
        <span class="info-detail">Account Address:</span><span class="account-address highlighted">{{ configuration_file.account.address }}</span>
      </li>
      <li>
        <span class="info-detail">Current ETH:</span><span class="account-eth-balance highlighted">N/A</span>
      </li>
      <li>
        <span class="info-detail">Current RDN:</span><span class="account-rdn-balance highlighted">N/A</span>
      </li>
    </ul>
    <button id="btn-launch" class="button next-page" onClick="launchRaiden('{{ configuration_file.file_name }}');" disabled>
      Launch Raiden
    </button>
  </div>
</div>

<div id="exchange-options">
  <h2>Acquire RDN through Decentralized Exchanges</h2>
  <p class="disclaimer tbd">
    Below we provide exchanges that are integrated with the Wizard. As
    soon as you deposit some ETH to your account address above, the
    Wizard can call to these Exchanges API and acquire RDN for you.
  </p>
  <p class="disclaimer tbd">Use at your risk.</p>


  <ul class="exchanges">
    <li>
      <a class="button" href="{{ reverse_url('swap', 'kyber', configuration_file.file_name)}}" disabled>KyberNetwork</a>
    </li>
    <li>
      <a class="button" href="{{ reverse_url('swap', 'uniswap', configuration_file.file_name)}}" disabled>Uniswap</a>
    </li>
  </ul>
</div>
{% end %}


{% block page_header_scripts %}
<script type="text/javascript">
 function checkBalances(){
   let url = "{{ reverse_url('api-configuration-detail', configuration_file.file_name) }}";
   let req = new XMLHttpRequest();
   let eth_balance_display_element = document.querySelector("span.account-eth-balance");
   let rdn_balance_display_element = document.querySelector("span.account-rdn-balance");

   req.open("GET", url);
   req.setRequestHeader("Content-Type", "application/json");

   req.onload = function() {
     if (this.status == 200){
       let btn = document.querySelector("#btn-launch");
       let balance = JSON.parse(this.response).balance;

       eth_balance_display_element.textContent = balance && balance.ETH.formatted;
       rdn_balance_display_element.textContent = balance && balance.RDN.formatted;
       btn.disabled = !(balance && balance.RDN.as_wei > 0);
     }
   }
   req.send();

 }


 window.addEventListener("load", function() {


   const main_screen = document.getElementById("funding-options");
   const redirection_panel = document.getElementById("external-site-redirection");

   checkBalances();

   document.querySelectorAll("ul.exchanges button").forEach(function(elem) {
     elem.addEventListener("click", function(evt){
       let site_name = this.getAttribute("data-name");
       let url = this.getAttribute("data-link");
       let span_exchange_elem = redirection_panel.querySelector("span.exchange-name");
       let link_elem = redirection_panel.querySelector("a.external-site");
       span_exchange_elem.textContent = site_name;
       link_elem.setAttribute("href", url);
       link_elem.textContent = "Proceed to " + site_name;
       main_screen.hidden = true;
       redirection_panel.hidden = false;
     });
   });

   document.querySelectorAll("button.cancel").forEach(function(elem) {
     elem.addEventListener("click", function(evt) {
       redirection_panel.hidden = true;
       main_screen.hidden = false;
     });
   });

   setInterval(checkBalances, 5000);

 });
</script>
{% end %}
